#!groovy

properties([disableConcurrentBuilds()])


node('Backend'){
    options {
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '5'))
        timestamps()
    }
    
    if ( ref == 'refs/heads/backend' )  {
        stage('Checkout')  {
            git branch: 'backend', credentialsId: 'ssh-key-main', url: 'git@github.com:Ihor-Porokhnia/WebApp.git'
        }
        stage('Build')  {
            sh 'mvn versions:set  -DnewVersion=0.0.' + env.BUILD_ID +'-SNAPSHOT'
            telegramSend(message: 'Build # ' + env.BUILD_ID + ' started' , chatId: -393518449)
            sh 'mvn clean install'
        }
        stage('Deploy')  {
           
           telegramSend(message: 'Staging deploy build # ' + env.BUILD_ID + ' started' , chatId: -393518449)
           sh 'sudo cp target/Backend-0.0.'+ env.BUILD_ID + '-SNAPSHOT.war /opt/tomcat/latest/webapps/Backend.war'
           sh 'sudo systemctl restart tomcat'
           sh 'sudo systemctl restart nginx'
           telegramSend(message: 'Staging deploy build # ' + env.BUILD_ID + ' done' , chatId: -393518449)
        }
    } else {
              sh 'echo notback'
    }
}


node('Frontend'){
    if ( ref == 'refs/heads/frontend')  {
              sh 'echo $ref'
    } else {
              sh 'echo notfront'
    }
}
